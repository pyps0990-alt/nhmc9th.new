<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>出缺勤點名 | 內湖高中軍武社</title>

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body class="bg-gray-900 text-white">

  <!-- 導覽列 -->
  <header class="bg-green-900 p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-yellow-400">內湖高中軍武社</h1>
    <nav class="space-x-4">
      <a href="../index.html" class="hover:text-yellow-300">首頁</a>
      <a href="schedule.html" class="hover:text-yellow-300">活動排程</a>
      <a href="attendance.html" class="text-yellow-300 font-bold">出缺勤</a>
      <a href="finance.html" class="hover:text-yellow-300">財務紀錄</a>
      <a href="knowledge.html" class="hover:text-yellow-300">知識分享</a>
      <a href="about.html" class="hover:text-yellow-300">關於我們</a>
    </nav>
  </header>

  <!-- 主內容 -->
  <main class="p-8">
    <h2 class="text-3xl font-bold text-yellow-300 mb-4">✅ 出缺勤點名</h2>

    <!-- 日期選擇 -->
    <div class="mb-4">
      <label for="date-picker" class="mr-2">選擇日期：</label>
      <input type="date" id="date-picker" class="text-black px-2 py-1 rounded">
    </div>

    <!-- Tabs -->
    <div id="tab-container" class="flex space-x-4 mb-6">
      <button class="tab-btn bg-green-700 px-4 py-2 rounded" data-tab="class1">第1堂課</button>
    </div>

    <!-- 控制按鈕 -->
    <div class="mb-6 space-x-2">
      <button id="add-class" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-500">➕ 新增堂數</button>
      <button id="clear-data" class="bg-red-600 px-4 py-2 rounded hover:bg-red-500">🗑 清除紀錄</button>
    </div>

    <!-- Tab 內容容器 -->
    <div id="content-container">
      <!-- 第1堂課 -->
      <div id="class1" class="tab-content active">
        <table class="w-full bg-green-800 text-white rounded shadow mb-2">
          <thead>
            <tr class="bg-green-700">
              <th class="p-2 text-left">姓名</th>
              <th class="p-2 text-center">出席</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="p-2">20620 陳奕嘉</td>
              <td class="p-2 text-center"><input type="checkbox" class="attendance-1"></td>
            </tr>
            <tr>
              <td class="p-2">20934 韓怡萱</td>
              <td class="p-2 text-center"><input type="checkbox" class="attendance-1"></td>
            </tr>
          </tbody>
        </table>
        出席人數：<span id="count-1" class="text-yellow-300 font-bold">0</span> 人
      </div>
    </div>
  </main>

  <!-- JS -->
  <script>
    const tabContainer = document.getElementById("tab-container");
    const contentContainer = document.getElementById("content-container");
    const addClassBtn = document.getElementById("add-class");
    const clearBtn = document.getElementById("clear-data");
    const datePicker = document.getElementById("date-picker");
    let classCount = 1;
    let currentDate = new Date().toISOString().split("T")[0];
    datePicker.value = currentDate;

    // 儲存到 LocalStorage（依日期）
    function saveData() {
      const data = [];
      for (let i = 1; i <= classCount; i++) {
        const checkboxes = document.querySelectorAll(`.attendance-${i}`);
        const states = Array.from(checkboxes).map(cb => cb.checked);
        data.push({ classId: i, states });
      }
      localStorage.setItem("attendance-" + currentDate, JSON.stringify(data));
      localStorage.setItem("classCount-" + currentDate, classCount);
    }

    // 載入 LocalStorage
    function loadData() {
      const savedCount = localStorage.getItem("classCount-" + currentDate);
      if (savedCount) {
        classCount = parseInt(savedCount);
        for (let i = 2; i <= classCount; i++) {
          createClass(i);
        }
      }
      const savedData = JSON.parse(localStorage.getItem("attendance-" + currentDate) || "[]");
      savedData.forEach(d => {
        const checkboxes = document.querySelectorAll(`.attendance-${d.classId}`);
        d.states.forEach((state, idx) => {
          if (checkboxes[idx]) checkboxes[idx].checked = state;
        });
        updateCount(d.classId);
      });
    }

    // Tab 切換
    function switchTab(tabId, tabBtn) {
      document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
      document.querySelectorAll(".tab-btn").forEach(t => t.classList.remove("bg-yellow-500"));
      document.getElementById(tabId).classList.add("active");
      tabBtn.classList.add("bg-yellow-500");
    }

    tabContainer.addEventListener("click", e => {
      if (e.target.classList.contains("tab-btn")) {
        switchTab(e.target.dataset.tab, e.target);
      }
    });

    // 出勤計算
    function setupAttendance(className, counterId, classId) {
      const checkboxes = document.querySelectorAll("." + className);
      const countDisplay = document.getElementById(counterId);

      function updateCount() {
        const count = Array.from(checkboxes).filter(cb => cb.checked).length;
        countDisplay.textContent = count;
        saveData();
      }

      checkboxes.forEach(cb => cb.addEventListener("change", updateCount));
      updateCount();
    }

    function updateCount(classId) {
      const checkboxes = document.querySelectorAll(`.attendance-${classId}`);
      const countDisplay = document.getElementById(`count-${classId}`);
      const count = Array.from(checkboxes).filter(cb => cb.checked).length;
      countDisplay.textContent = count;
    }

    // 建立新堂數
    function createClass(num) {
      const tabId = "class" + num;

      const newTab = document.createElement("button");
      newTab.className = "tab-btn bg-green-700 px-4 py-2 rounded";
      newTab.dataset.tab = tabId;
      newTab.textContent = `第${num}堂課`;
      tabContainer.appendChild(newTab);

      const newContent = document.createElement("div");
      newContent.id = tabId;
      newContent.className = "tab-content";
      newContent.innerHTML = `
        <table class="w-full bg-green-800 text-white rounded shadow mb-2">
          <thead>
            <tr class="bg-green-700">
              <th class="p-2 text-left">姓名</th>
              <th class="p-2 text-center">出席</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="p-2">20620 陳奕嘉</td>
              <td class="p-2 text-center"><input type="checkbox" class="attendance-${num}"></td>
            </tr>
            <tr>
              <td class="p-2">20934 韓怡萱</td>
              <td class="p-2 text-center"><input type="checkbox" class="attendance-${num}"></td>
            </tr>
          </tbody>
        </table>
        出席人數：<span id="count-${num}" class="text-yellow-300 font-bold">0</span> 人
      `;
      contentContainer.appendChild(newContent);

      setupAttendance(`attendance-${num}`, `count-${num}`, num);
    }

    // 新增堂數
    addClassBtn.addEventListener("click", () => {
      classCount++;
      createClass(classCount);
      saveData();
    });

    // 清除紀錄
    clearBtn.addEventListener("click", () => {
      if (confirm("確定要清除這個日期的出缺勤紀錄嗎？")) {
        localStorage.removeItem("attendance-" + currentDate);
        localStorage.removeItem("classCount-" + currentDate);
        location.reload();
      }
    });

    // 日期切換
    datePicker.addEventListener("change", () => {
      currentDate = datePicker.value;
      // 清空畫面
      contentContainer.innerHTML = '';
      tabContainer.innerHTML = '';
      classCount = 1;
      // 重建第一堂課
      const firstTab = document.createElement("button");
      firstTab.className = "tab-btn bg-green-700 px-4 py-2 rounded";
      firstTab.dataset.tab = "class1";
      firstTab.textContent = "第1堂課";
      tabContainer.appendChild(firstTab);

      const firstContent = document.createElement("div");
      firstContent.id = "class1";
      firstContent.className = "tab-content active";
      firstContent.innerHTML = `
        <table class="w-full bg-green-800 text-white rounded shadow mb-2">
          <thead>
            <tr class="bg-green-700">
              <th class="p-2 text-left">姓名</th>
              <th class="p-2 text-center">出席</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="p-2">20620 陳奕嘉</td>
              <td class="p-2 text-center"><input type="checkbox" class="attendance-1"></td>
            </tr>
            <tr>
              <td class="p-2">20934 韓怡萱</td>
              <td class="p-2 text-center"><input type="checkbox" class="attendance-1"></td>
            </tr>
          </tbody>
        </table>
        出席人數：<span id="count-1" class="text-yellow-300 font-bold">0</span> 人
      `;
      contentContainer.appendChild(firstContent);

      setupAttendance("attendance-1", "count-1", 1);
      loadData();
    });

    // 初始化
    setupAttendance("attendance-1", "count-1", 1);
    loadData();
  </script>
</body>
</html>