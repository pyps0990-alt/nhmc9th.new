<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å‡ºç¼ºå‹¤é»å | å…§æ¹–é«˜ä¸­è»æ­¦ç¤¾</title>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body class="bg-gray-900 text-white">

<header class="bg-green-900 p-4 flex justify-between items-center">
  <h1 class="text-2xl font-bold text-yellow-400">å…§æ¹–é«˜ä¸­è»æ­¦ç¤¾</h1>
</header>

<main class="p-8">
  <h2 class="text-3xl font-bold text-yellow-300 mb-4">âœ… å‡ºç¼ºå‹¤é»å</h2>

  <!-- æ—¥æœŸé¸æ“‡ -->
  <div class="mb-4">
    <label for="date-picker" class="mr-2">é¸æ“‡æ—¥æœŸï¼š</label>
    <input type="date" id="date-picker" class="text-black px-2 py-1 rounded">
  </div>

  <!-- Tabs -->
  <div id="tab-container" class="flex space-x-4 mb-6"></div>

  <!-- æ§åˆ¶æŒ‰éˆ• -->
  <div class="mb-6 space-x-2">
    <button id="add-class" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-500">â• æ–°å¢å ‚æ•¸</button>
    <button id="clear-data" class="bg-red-600 px-4 py-2 rounded hover:bg-red-500">ğŸ—‘ æ¸…é™¤ç´€éŒ„</button>
    <button id="export-csv" class="bg-yellow-500 px-4 py-2 rounded hover:bg-yellow-400">ğŸ“¥ åŒ¯å‡º CSV</button>
  </div>

  <!-- Tab å…§å®¹å®¹å™¨ -->
  <div id="content-container"></div>
</main>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyHoY-o3tJ8mGBrV866WYm5UxSpvxSzhVGK_Rvp3Nfi5xXgO7fDsapLpCh-hYlCTVFa/exec";

const datePicker = document.getElementById("date-picker");
const tabContainer = document.getElementById("tab-container");
const contentContainer = document.getElementById("content-container");
const addClassBtn = document.getElementById("add-class");
const clearBtn = document.getElementById("clear-data");
const exportBtn = document.getElementById("export-csv");

let currentDate = new Date().toISOString().split("T")[0];
datePicker.value = currentDate;
let classCount = 1;

// ğŸ”¹ ç¤¾å“¡åå–®
const members = [
  "10112 è¨±ç´˜ç‘","10410 é»ƒæµ©æ©","10421 ç™½é›¨æ™¨","10512 é™³å† å»·","10527 æ¢ç‘ç´—",
  "10803 é™³éŸ‹æ›„","10901 ç‹ç¿Šå®¸","10909 å¼µæ™ºç¿”","10916 åŠ‰æ·»æ·³","11017 è¬é›¨æ³“",
  "11105 å¼µåšå‡±","11511 éƒ­å…†å´´","11514 é»ƒå®¶å®","11603 æç¿Šæ„·","11714 æˆ´æ—­å›",
  "20103 å‘¨å…ƒå‡±","20113 è—å®‡æ©","20237 é„§æ•ç¿","20335 è”¡ç¶­å¦®","20508 ææ–‡å‡±",
  "20618 è¨±å¾·æµ©","20620 é™³å¥•å˜‰","20625 åŠ‰å®¸å»·","20702 å‘‚ç¥å¡","20715 é™³ä¿Šç¿",
  "20907 é‚±å½¥å¡","20918 é»ƒå‹é ¡","20934 éŸ“æ€¡è±","21016 é»ƒå­å®¸","21315 è•­å·é–”",
  "21605 æç·’æ†","21606 æ´ªå­çš“","21629 æ¸¸é–”å–¬","21703 ä½•å®¶æ¿¬"
];

// ğŸ”¹ å»ºç«‹å–®å ‚èª²è¡¨æ ¼
function createClass(num){
  const tabId = "class"+num;
  if(document.getElementById(tabId)) return; // âœ… é¿å…é‡è¤‡å‰µå»º

  // Tab
  const newTab = document.createElement("button");
  newTab.className = "tab-btn bg-green-700 px-4 py-2 rounded";
  newTab.dataset.tab = tabId;
  newTab.textContent = `ç¬¬${num}å ‚èª²`;
  tabContainer.appendChild(newTab);

  // Content
  const newContent = document.createElement("div");
  newContent.id = tabId;
  newContent.className = "tab-content";

  let tbodyHTML = members.map(name=>
    `<tr>
      <td class="p-2">${name}</td>
      <td class="p-2 text-center"><input type="checkbox" class="attendance-${num}" data-name="${name}"></td>
    </tr>`).join("");

  newContent.innerHTML = `
    <table class="w-full bg-green-800 text-white rounded shadow mb-2">
      <thead>
        <tr class="bg-green-700">
          <th class="p-2 text-left">å§“å</th>
          <th class="p-2 text-center">å‡ºå¸­</th>
        </tr>
      </thead>
      <tbody>${tbodyHTML}</tbody>
    </table>
    å‡ºå¸­äººæ•¸ï¼š<span id="count-${num}" class="text-yellow-300 font-bold">0</span> äºº
  `;

  contentContainer.appendChild(newContent);
  setupAttendance(`attendance-${num}`, `count-${num}`, num);

  // ğŸ”¹ ç¬¬ä¸€å ‚èª²è‡ªå‹•åˆ‡æ› active
  if(num === 1) switchTab(tabId, newTab);
}

// ğŸ”¹ Tab åˆ‡æ›
function switchTab(tabId, tabBtn){
  document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(t=>t.classList.remove("bg-yellow-500"));
  document.getElementById(tabId).classList.add("active");
  tabBtn.classList.add("bg-yellow-500");
}

tabContainer.addEventListener("click", e=>{
  if(e.target.classList.contains("tab-btn")){
    switchTab(e.target.dataset.tab, e.target);
  }
});

// ğŸ”¹ å‡ºå‹¤è¨ˆç®— & åŒæ­¥ Google Sheet
function setupAttendance(className, counterId, classNum){
  const checkboxes = document.querySelectorAll("."+className);
  const countDisplay = document.getElementById(counterId);

  async function updateCount(cb){
    const count = Array.from(checkboxes).filter(c=>c.checked).length;
    countDisplay.textContent = count;

    const name = cb.dataset.name;
    const attendance = cb.checked ? 1 : 0;
    await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({date:currentDate,class:classNum,name,attendance})
    });
  }

  checkboxes.forEach(cb=>cb.addEventListener("change", ()=>updateCount(cb)));
  loadAttendance(classNum);
}

// ğŸ”¹ è®€å– Google Sheet è³‡æ–™
async function loadAttendance(classNum){
  const res = await fetch(`${API_URL}?date=${currentDate}`);
  const data = await res.json();
  const checkboxes = document.querySelectorAll(`.attendance-${classNum}`);
  checkboxes.forEach(cb=>{
    const record = data.find(r=>Number(r.class)===classNum && r.name===cb.dataset.name);
    if(record) cb.checked = record.attendance==1;
  });
  const count = Array.from(checkboxes).filter(c=>c.checked).length;
  document.getElementById(`count-${classNum}`).textContent = count;
}

// ğŸ”¹ æ–°å¢å ‚æ•¸
addClassBtn.addEventListener("click", ()=>{
  classCount++;
  createClass(classCount);
});

// ğŸ”¹ æ¸…é™¤ç´€éŒ„
clearBtn.addEventListener("click", ()=>{
  if(confirm("ç¢ºå®šæ¸…é™¤é€™å€‹æ—¥æœŸçš„å‡ºç¼ºå‹¤ç´€éŒ„å—ï¼Ÿ")){
    fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({date:currentDate,class:-1,name:"clear",attendance:0})
    }).then(()=>location.reload());
  }
});

// ğŸ”¹ æ—¥æœŸåˆ‡æ›
datePicker.addEventListener("change", ()=>{
  currentDate = datePicker.value;
  contentContainer.innerHTML = "";
  tabContainer.innerHTML = "";
  classCount = 1;
  createClass(1);
});

// ğŸ”¹ åŒ¯å‡º CSV
exportBtn.addEventListener("click", ()=>{
  let csv = "å ‚æ•¸,å§“å,å‡ºå¸­\n";
  for(let c=1;c<=classCount;c++){
    const checkboxes = document.querySelectorAll(`.attendance-${c}`);
    checkboxes.forEach(cb=>{
      csv += `${c},${cb.dataset.name},${cb.checked?1:0}\n`;
    });
  }
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `${currentDate}_attendance.csv`;
  a.click();
});

// ğŸ”¹ åˆå§‹åŒ–ç¬¬ä¸€å ‚èª²
createClass(1);
</script>
</body>
</html>