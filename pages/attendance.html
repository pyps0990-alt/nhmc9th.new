<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>軍武社簽到系統</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white p-6">

  <h1 class="text-3xl font-bold text-yellow-300 mb-4">✅ 軍武社出缺勤簽到系統</h1>

  <div class="mb-4">
    <label for="date-picker" class="mr-2">選擇日期：</label>
    <input type="date" id="date-picker" class="text-black px-2 py-1 rounded">
  </div>

  <div class="mb-4 space-x-2">
    <button id="add-class" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-500">➕ 新增堂數</button>
    <button id="save-attendance" class="bg-green-600 px-4 py-2 rounded hover:bg-green-500">💾 儲存簽到</button>
    <button id="export-csv" class="bg-yellow-500 px-4 py-2 rounded hover:bg-yellow-400">📥 匯出 CSV</button>
  </div>

  <div id="tab-container" class="flex space-x-4 mb-6"></div>
  <div id="content-container"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxBQiShwk_6RrrbxlZzpx6kvbPr7evBmaEEO1kTeRB15R5M2kObrtVD-O3IzILG2Wq_/exec";
    const datePicker = document.getElementById("date-picker");
    const tabContainer = document.getElementById("tab-container");
    const contentContainer = document.getElementById("content-container");
    const addClassBtn = document.getElementById("add-class");
    const saveBtn = document.getElementById("save-attendance");
    const exportBtn = document.getElementById("export-csv");

    let currentDate = new Date().toISOString().split("T")[0];
    datePicker.value = currentDate;
    let classCount = 1;

    const members = [
      "10112 許紘瑞","10410 黃浩恩","10421 白雨晨","10512 陳冠廷","10527 梁瑞紗",
      "10803 陳韋曄","10901 王翊宸","10909 張智翔","10916 劉添淳","11017 謝雨泓",
      "11105 張博凱","11511 郭兆崴","11514 黃家宏","11603 李翊愷","11714 戴旭君",
      "20103 周元凱","20113 藍宇恩","20237 鄧敏翎","20335 蔡維妮","20508 李文凱",
      "20618 許德浩","20620 陳奕嘉","20625 劉宸廷","20702 呂祁叡","20715 陳俊睿",
      "20907 邱彥叡","20918 黃友頡","20934 韓怡萱","21016 黃子宸","21315 蕭川閔",
      "21605 李緒恆","21606 洪子皓","21629 游閔喬","21703 何家濬"
    ];

    function createClass(num){
      const tabId = "class"+num;
      const tabBtn = document.createElement("button");
      tabBtn.className="tab-btn bg-green-700 px-4 py-2 rounded";
      tabBtn.dataset.tab = tabId;
      tabBtn.textContent = `第${num}堂課`;
      tabContainer.appendChild(tabBtn);

      const tabContent = document.createElement("div");
      tabContent.id = tabId;
      tabContent.className="tab-content";

      tabContent.innerHTML = `
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
          ${members.map(name => `
            <div class="flex items-center justify-between bg-green-800 p-3 rounded shadow">
              <span class="text-white font-medium">${name}</span>
              <input type="checkbox" class="attendance-${num}" data-name="${name}">
            </div>
          `).join("")}
        </div>
        <div class="text-right text-yellow-300 font-bold">👥 出席人數：<span id="count-${num}">0</span> 人</div>
      `;

      contentContainer.appendChild(tabContent);
      setupAttendance(num);
    }

    function switchTab(tabId, tabBtn){
      document.querySelectorAll(".tab-content").forEach(c=>c.style.display="none");
      document.querySelectorAll(".tab-btn").forEach(t=>t.classList.remove("bg-yellow-500"));
      document.getElementById(tabId).style.display="block";
      tabBtn.classList.add("bg-yellow-500");
    }

    tabContainer.addEventListener("click", e=>{
      if(e.target.classList.contains("tab-btn")) switchTab(e.target.dataset.tab,e.target);
    });

    function setupAttendance(classNum){
      const checkboxes = document.querySelectorAll(`.attendance-${classNum}`);
      const countDisplay = document.getElementById(`count-${classNum}`);
      function updateCount(){ countDisplay.textContent = Array.from(checkboxes).filter(c=>c.checked).length; }
      checkboxes.forEach(cb=>cb.addEventListener("change",updateCount));
      updateCount();
    }

    addClassBtn.addEventListener("click",()=>{
      classCount++;
      createClass(classCount);
      switchTab(`class${classCount}`,document.querySelectorAll(".tab-btn")[classCount-1]);
    });

    saveBtn.addEventListener("click",()=>{
      const payload = [];
      for(let c=1;c<=classCount;c++){
        const checkboxes = document.querySelectorAll(`.attendance-${c}`);
        checkboxes.forEach(cb=>{
          payload.push({
            date: datePicker.value,
            class: c,
            name: cb.dataset.name,
            attendance: cb.checked ? 1 : 0,
            token: "junwu2025" // ← 幹部密碼（可選）
          });
        });
      }
      fetch(API_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      }).then(()=>alert("✅ 已儲存簽到資料！"));
        .then(res => res.text())
        .then(msg => alert(msg))
        .catch(err => alert("❌ 發送失敗：" + err));
    });

    exportBtn.addEventListener("click",()=>{
      let csv="堂數,姓名,出席\n";
      for(let c=1;c<=classCount;c++){
        const checkboxes = document.querySelectorAll(`.attendance-${c}`);
        checkboxes.forEach(cb=>{ csv+=`${c},${cb.dataset.name},${cb.checked?1:0}\n`; });
      }
      const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url; a.download=`${datePicker.value}_attendance.csv`; a.click();
    });

    createClass(1);
    switchTab("class1",document.querySelector(".tab-btn"));
  </script>
</body>
</html>
