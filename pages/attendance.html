<html lang="zh-Hant">
<!DOCTYPE html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å‡ºç¼ºå‹¤é»å | å…§æ¹–é«˜ä¸­è»æ­¦ç¤¾</title>

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- SheetJS (Excel ä¸‹è¼‰) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body class="bg-gray-900 text-white">

  <!-- å°è¦½åˆ— -->
  <header class="bg-green-900 p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-yellow-400">å…§æ¹–é«˜ä¸­è»æ­¦ç¤¾</h1>
    <nav class="space-x-4">
      <a href="../index.html" class="hover:text-yellow-300">é¦–é </a>
      <a href="schedule.html" class="hover:text-yellow-300">æ´»å‹•æ’ç¨‹</a>
      <a href="attendance.html" class="text-yellow-300 font-bold">å‡ºç¼ºå‹¤</a>
      <a href="finance.html" class="hover:text-yellow-300">è²¡å‹™ç´€éŒ„</a>
      <a href="knowledge.html" class="hover:text-yellow-300">çŸ¥è­˜åˆ†äº«</a>
      <a href="about.html" class="hover:text-yellow-300">é—œæ–¼æˆ‘å€‘</a>
    </nav>
  </header>

  <!-- ä¸»å…§å®¹ -->
  <main class="p-8">
    <h2 class="text-3xl font-bold text-yellow-300 mb-4">âœ… å‡ºç¼ºå‹¤é»å</h2>

    <!-- æ—¥æœŸé¸æ“‡ -->
    <div class="mb-6 flex items-center space-x-4">
      <div>
        <label for="date-picker" class="mr-2">é¸æ“‡æ—¥æœŸï¼š</label>
        <input type="date" id="date-picker" class="text-black px-2 py-1 rounded">
      </div>
      <button id="export-excel" class="bg-yellow-500 px-4 py-2 rounded hover:bg-yellow-400">ğŸ“‚ åŒ¯å‡º Excel</button>
    </div>

    <!-- Tabs -->
    <div id="tab-container" class="flex space-x-4 mb-6">
      <button class="tab-btn bg-green-700 px-4 py-2 rounded" data-tab="class1">ç¬¬1å ‚èª²</button>
    </div>
    <button id="add-class" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-500 mb-4">â• æ–°å¢å ‚æ•¸</button>

    <!-- Tab å…§å®¹å®¹å™¨ -->
    <div id="content-container"></div>
  </main>

  <!-- JS -->
  <script>
    const tabContainer = document.getElementById("tab-container");
    const contentContainer = document.getElementById("content-container");
    const addClassBtn = document.getElementById("add-class");
    const datePicker = document.getElementById("date-picker");
    const exportBtn = document.getElementById("export-excel");
    let classCount = 1;
    let currentDate = new Date().toISOString().split("T")[0]; // é è¨­ä»Šå¤©æ—¥æœŸ
    datePicker.value = currentDate;

    // ğŸ”¹ ç¤¾å“¡åå–®
    const members = [
      "10112 è¨±ç´˜ç‘","10410 é»ƒæµ©æ©","10421 ç™½é›¨æ™¨","10512 é™³å† å»·","10527 æ¢ç‘ç´—",
      "10803 é™³éŸ‹æ›„","10901 ç‹ç¿Šå®¸","10909 å¼µæ™ºç¿”","10916 åŠ‰æ·»æ·³","11017 è¬é›¨æ³“",
      "11105 å¼µåšå‡±","11511 éƒ­å…†å´´","11514 é»ƒå®¶å®","11603 æç¿Šæ„·","11714 æˆ´æ—­å›",
      "20103 å‘¨å…ƒå‡±","20113 è—å®‡æ©","20237 é„§æ•ç¿","20335 è”¡ç¶­å¦®","20508 ææ–‡å‡±",
      "20618 è¨±å¾·æµ©","20620 é™³å¥•å˜‰","20625 åŠ‰å®¸å»·","20702 å‘‚ç¥å¡","20715 é™³ä¿Šç¿",
      "20907 é‚±å½¥å¡","20918 é»ƒå‹é ¡","20934 éŸ“æ€¡è±","21016 é»ƒå­å®¸","21315 è•­å·é–”",
      "21605 æç·’æ†","21606 æ´ªå­çš“","21629 æ¸¸é–”å–¬","21703 ä½•å®¶æ¿¬"
    ];

    // å»ºç«‹ä¸€å€‹å ‚æ•¸çš„é»åè¡¨
    function createClassTab(num) {
      const tabId = "class" + num;

      // Tab æŒ‰éˆ•
      if (!document.querySelector(`[data-tab="${tabId}"]`)) {
        const newTab = document.createElement("button");
        newTab.className = "tab-btn bg-green-700 px-4 py-2 rounded";
        newTab.dataset.tab = tabId;
        newTab.textContent = `ç¬¬${num}å ‚èª²`;
        tabContainer.appendChild(newTab);
      }

      // è¡¨æ ¼å…§å®¹
      const newContent = document.createElement("div");
      newContent.id = tabId;
      newContent.className = "tab-content" + (num === 1 ? " active" : "");
      let rows = "";
      members.forEach(m => {
        rows += `
          <tr>
            <td class="p-2">${m}</td>
            <td class="p-2 text-center"><input type="checkbox" class="attendance-${num}"></td>
          </tr>
        `;
      });
      newContent.innerHTML = `
        <table class="w-full bg-green-800 text-white rounded shadow mb-2">
          <thead>
            <tr class="bg-green-700">
              <th class="p-2 text-left">å§“å</th>
              <th class="p-2 text-center">å‡ºå¸­</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
        å‡ºå¸­äººæ•¸ï¼š<span id="count-${num}" class="text-yellow-300 font-bold">0</span> äºº
      `;
      contentContainer.appendChild(newContent);

      // å‡ºå‹¤è¨ˆç®—
      setupAttendance(`attendance-${num}`, `count-${num}`);
    }

    // å‡ºå‹¤è¨ˆç®—
    function setupAttendance(className, counterId) {
      const checkboxes = document.querySelectorAll("." + className);
      const countDisplay = document.getElementById(counterId);

      function updateCount() {
        const count = Array.from(checkboxes).filter(cb => cb.checked).length;
        countDisplay.textContent = count;
        saveData();
      }

      checkboxes.forEach(cb => cb.addEventListener("change", updateCount));
    }

    // å‡ºå‹¤è³‡æ–™å­˜ localStorage
    function saveData() {
      const data = {};
      document.querySelectorAll(".tab-content").forEach((tab, index) => {
        const checkboxes = tab.querySelectorAll("input[type=checkbox]");
        data["class" + (index+1)] = Array.from(checkboxes).map(cb => cb.checked);
      });
      localStorage.setItem("attendance-" + currentDate, JSON.stringify(data));
    }

    function loadData() {
      const saved = localStorage.getItem("attendance-" + currentDate);
      if (!saved) return;
      const data = JSON.parse(saved);
      Object.keys(data).forEach(classId => {
        const checkboxes = document.querySelectorAll("." + classId.replace("class", "attendance-"));
        checkboxes.forEach((cb, i) => {
          cb.checked = data[classId][i] || false;
        });
      });
      updateAllCounts();
    }

    function updateAllCounts() {
      for (let i = 1; i <= classCount; i++) {
        const checkboxes = document.querySelectorAll(".attendance-" + i);
        const countDisplay = document.getElementById("count-" + i);
        if (countDisplay) {
          const count = Array.from(checkboxes).filter(cb => cb.checked).length;
          countDisplay.textContent = count;
        }
      }
    }

    // Tab åˆ‡æ›
    tabContainer.addEventListener("click", e => {
      if (e.target.classList.contains("tab-btn")) {
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        document.querySelectorAll(".tab-btn").forEach(t => t.classList.remove("bg-yellow-500"));
        document.getElementById(e.target.dataset.tab).classList.add("active");
        e.target.classList.add("bg-yellow-500");
      }
    });

    // æ–°å¢å ‚æ•¸
    addClassBtn.addEventListener("click", () => {
      classCount++;
      createClassTab(classCount);
    });

    // åˆ‡æ›æ—¥æœŸ
    datePicker.addEventListener("change", () => {
      currentDate = datePicker.value;
      document.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);
      updateAllCounts();
      loadData();
    });

    // åŒ¯å‡º Excel
    exportBtn.addEventListener("click", () => {
      const rows = [["æ—¥æœŸ", currentDate], [], ["å ‚æ•¸", "å§“å", "å‡ºå¸­"]];
      for (let i = 1; i <= classCount; i++) {
        const tab = document.getElementById("class" + i);
        if (!tab) continue;
        const trs = tab.querySelectorAll("tbody tr");
        trs.forEach(tr => {
          const name = tr.querySelector("td").innerText;
          const checked = tr.querySelector("input").checked ? "âœ”ï¸" : "âŒ";
          rows.push([`ç¬¬${i}å ‚èª²`, name, checked]);
        });
        rows.push([]);
      }
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "å‡ºç¼ºå‹¤");
      XLSX.writeFile(wb, `å‡ºç¼ºå‹¤_${currentDate}.xlsx`);
    });

    // é è¨­å»ºç«‹ç¬¬ä¸€å ‚èª² + è¼‰å…¥è³‡æ–™
    createClassTab(1);
    loadData();
  </script>
</body>
</html>