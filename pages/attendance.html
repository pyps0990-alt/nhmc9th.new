<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å‡ºç¼ºå‹¤ç°½åˆ°ç³»çµ± | å…§æ¹–é«˜ä¸­è»æ­¦ç¤¾</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
.tab-content { display: none; }
.tab-content.active { display: block !important; }
</style>
</head>
<body class="bg-gray-900 text-white">

<header class="bg-green-900 p-4 flex justify-between items-center">
  <h1 class="text-2xl font-bold text-yellow-400">å…§æ¹–é«˜ä¸­è»æ­¦ç¤¾</h1>
  <nav class="space-x-4">
    <a href="../index.html" class="hover:text-yellow-300">é¦–é </a>
    <a href="schedule.html" class="hover:text-yellow-300">æ´»å‹•æ’ç¨‹</a>
    <a href="attendance.html" class="text-yellow-300 font-bold">å‡ºç¼ºå‹¤</a>
    <a href="finance.html" class="hover:text-yellow-300">è²¡å‹™ç´€éŒ„</a>
    <a href="knowledge.html" class="hover:text-yellow-300">çŸ¥è­˜åˆ†äº«</a>
    <a href="about.html" class="hover:text-yellow-300">é—œæ–¼æˆ‘å€‘</a>
  </nav>
</header>

<main class="p-8">
<h2 class="text-3xl font-bold text-yellow-300 mb-4">âœ… å‡ºç¼ºå‹¤ç°½åˆ°ç³»çµ±</h2>

<div class="mb-4">
  <label for="date-picker" class="mr-2">é¸æ“‡æ—¥æœŸï¼š</label>
  <input type="date" id="date-picker" class="text-black px-2 py-1 rounded">
</div>

<div class="mb-4 space-x-2">
  <button id="add-class" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-500">â• æ–°å¢å ‚æ•¸</button>
  <button id="save-attendance" class="bg-green-600 px-4 py-2 rounded hover:bg-green-500">ğŸ’¾ å„²å­˜ç°½åˆ°</button>
  <button id="export-csv" class="bg-yellow-500 px-4 py-2 rounded hover:bg-yellow-400">ğŸ“¥ åŒ¯å‡º CSV</button>
</div>

<div id="tab-container" class="flex space-x-4 mb-6"></div>
<div id="content-container"></div>
</main>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwy9ATnBivb1PHx5Kbejr_t45FahMfVDBG_AOC4jP2mx4cFzkL2S7kL9jDkjDr56fup/exec";
const datePicker = document.getElementById("date-picker");
const tabContainer = document.getElementById("tab-container");
const contentContainer = document.getElementById("content-container");
const addClassBtn = document.getElementById("add-class");
const saveBtn = document.getElementById("save-attendance");
const exportBtn = document.getElementById("export-csv");

let currentDate = new Date().toISOString().split("T")[0];
datePicker.value = currentDate;
let classCount = 1;

const members = [
  "10112 è¨±ç´˜ç‘","10410 é»ƒæµ©æ©","10421 ç™½é›¨æ™¨","10512 é™³å† å»·","10527 æ¢ç‘ç´—",
  "10803 é™³éŸ‹æ›„","10901 ç‹ç¿Šå®¸","10909 å¼µæ™ºç¿”","10916 åŠ‰æ·»æ·³","11017 è¬é›¨æ³“",
  "11105 å¼µåšå‡±","11511 éƒ­å…†å´´","11514 é»ƒå®¶å®","11603 æç¿Šæ„·","11714 æˆ´æ—­å›",
  "20103 å‘¨å…ƒå‡±","20113 è—å®‡æ©","20237 é„§æ•ç¿","20335 è”¡ç¶­å¦®","20508 ææ–‡å‡±",
  "20618 è¨±å¾·æµ©","20620 é™³å¥•å˜‰","20625 åŠ‰å®¸å»·","20702 å‘‚ç¥å¡","20715 é™³ä¿Šç¿",
  "20907 é‚±å½¥å¡","20918 é»ƒå‹é ¡","20934 éŸ“æ€¡è±","21016 é»ƒå­å®¸","21315 è•­å·é–”",
  "21605 æç·’æ†","21606 æ´ªå­çš“","21629 æ¸¸é–”å–¬","21703 ä½•å®¶æ¿¬"
];

// å»ºç«‹èª²ç¨‹ Tab
function createClass(num){
  const tabId = "class"+num;
  const tabBtn = document.createElement("button");
  tabBtn.className="tab-btn bg-green-700 px-4 py-2 rounded";
  tabBtn.dataset.tab = tabId;
  tabBtn.textContent = `ç¬¬${num}å ‚èª²`;
  tabContainer.appendChild(tabBtn);

  const tabContent = document.createElement("div");
  tabContent.id = tabId;
  tabContent.className="tab-content";

  tabContent.innerHTML = `
  <table class="w-full bg-green-800 text-white rounded shadow mb-2">
    <thead>
      <tr class="bg-green-700"><th class="p-2 text-left">å§“å</th><th class="p-2 text-center">å‡ºå¸­</th></tr>
    </thead>
    <tbody>
      ${members.map(name=>`<tr><td class="p-2">${name}</td><td class="p-2 text-center"><input type="checkbox" class="attendance-${num}" data-name="${name}"></td></tr>`).join("")}
    </tbody>
  </table>
  å‡ºå¸­äººæ•¸ï¼š<span id="count-${num}" class="text-yellow-300 font-bold">0</span> äºº
  `;

  contentContainer.appendChild(tabContent);
  setupAttendance(num);
}

// Tab åˆ‡æ›
function switchTab(tabId, tabBtn){
  document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(t=>t.classList.remove("bg-yellow-500"));
  document.getElementById(tabId).classList.add("active");
  tabBtn.classList.add("bg-yellow-500");
}

tabContainer.addEventListener("click", e=>{
  if(e.target.classList.contains("tab-btn")) switchTab(e.target.dataset.tab,e.target);
});

// è¨ˆç®—å‡ºå¸­
function setupAttendance(classNum){
  const checkboxes = document.querySelectorAll(`.attendance-${classNum}`);
  const countDisplay = document.getElementById(`count-${classNum}`);
  function updateCount(){ countDisplay.textContent = Array.from(checkboxes).filter(c=>c.checked).length; }
  checkboxes.forEach(cb=>cb.addEventListener("change",updateCount));
  updateCount();
}

// æ–°å¢å ‚æ•¸
addClassBtn.addEventListener("click",()=>{
  classCount++;
  createClass(classCount);
  switchTab(`class${classCount}`,document.querySelectorAll(".tab-btn")[classCount-1]);
});

// å„²å­˜ç°½åˆ°
saveBtn.addEventListener("click",()=>{
  for(let c=1;c<=classCount;c++){
    const checkboxes = document.querySelectorAll(`.attendance-${c}`);
    checkboxes.forEach(cb=>{
      fetch(API_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          date:currentDate,
          class:c,
          name:cb.dataset.name,
          attendance: cb.checked?1:0
        })
      });
    });
  }
  alert("å·²å„²å­˜ç°½åˆ°è³‡æ–™ï¼");
});

// åŒ¯å‡º CSV
exportBtn.addEventListener("click",()=>{
  let csv="å ‚æ•¸,å§“å,å‡ºå¸­\n";
  for(let c=1;c<=classCount;c++){
    const checkboxes = document.querySelectorAll(`.attendance-${c}`);
    checkboxes.forEach(cb=>{ csv+=`${c},${cb.dataset.name},${cb.checked?1:0}\n`; });
  }
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=`${currentDate}_attendance.csv`; a.click();
});

// åˆå§‹åŒ–
createClass(1);
switchTab("class1",document.querySelector(".tab-btn"));
</script>

</body>
</html>