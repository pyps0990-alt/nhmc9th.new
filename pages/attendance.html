<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è»æ­¦ç¤¾ç°½åˆ°ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white p-6">

  <h1 class="text-3xl font-bold text-yellow-300 mb-4">âœ… è»æ­¦ç¤¾å‡ºç¼ºå‹¤ç°½åˆ°ç³»çµ±</h1>

  <div class="mb-4">
    <label for="date-picker" class="mr-2">é¸æ“‡æ—¥æœŸï¼š</label>
    <input type="date" id="date-picker" class="text-black px-2 py-1 rounded">
  </div>

  <div class="mb-4 space-x-2">
    <button id="add-class" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-500">â• æ–°å¢å ‚æ•¸</button>
    <button id="save-attendance" class="bg-green-600 px-4 py-2 rounded hover:bg-green-500">ğŸ’¾ å„²å­˜ç°½åˆ°</button>
    <button id="export-csv" class="bg-yellow-500 px-4 py-2 rounded hover:bg-yellow-400">ğŸ“¥ åŒ¯å‡º CSV</button>
  </div>

  <div id="tab-container" class="flex space-x-4 mb-6"></div>
  <div id="content-container"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxBQiShwk_6RrrbxlZzpx6kvbPr7evBmaEEO1kTeRB15R5M2kObrtVD-O3IzILG2Wq_/exec";
    const datePicker = document.getElementById("date-picker");
    const tabContainer = document.getElementById("tab-container");
    const contentContainer = document.getElementById("content-container");
    const addClassBtn = document.getElementById("add-class");
    const saveBtn = document.getElementById("save-attendance");
    const exportBtn = document.getElementById("export-csv");

    let currentDate = new Date().toISOString().split("T")[0];
    datePicker.value = currentDate;
    let classCount = 1;

    const members = [
      "10112 è¨±ç´˜ç‘","10410 é»ƒæµ©æ©","10421 ç™½é›¨æ™¨","10512 é™³å† å»·","10527 æ¢ç‘ç´—",
      "10803 é™³éŸ‹æ›„","10901 ç‹ç¿Šå®¸","10909 å¼µæ™ºç¿”","10916 åŠ‰æ·»æ·³","11017 è¬é›¨æ³“",
      "11105 å¼µåšå‡±","11511 éƒ­å…†å´´","11514 é»ƒå®¶å®","11603 æç¿Šæ„·","11714 æˆ´æ—­å›",
      "20103 å‘¨å…ƒå‡±","20113 è—å®‡æ©","20237 é„§æ•ç¿","20335 è”¡ç¶­å¦®","20508 ææ–‡å‡±",
      "20618 è¨±å¾·æµ©","20620 é™³å¥•å˜‰","20625 åŠ‰å®¸å»·","20702 å‘‚ç¥å¡","20715 é™³ä¿Šç¿",
      "20907 é‚±å½¥å¡","20918 é»ƒå‹é ¡","20934 éŸ“æ€¡è±","21016 é»ƒå­å®¸","21315 è•­å·é–”",
      "21605 æç·’æ†","21606 æ´ªå­çš“","21629 æ¸¸é–”å–¬","21703 ä½•å®¶æ¿¬"
    ];

    function createClass(num){
      const tabId = "class"+num;
      const tabBtn = document.createElement("button");
      tabBtn.className="tab-btn bg-green-700 px-4 py-2 rounded";
      tabBtn.dataset.tab = tabId;
      tabBtn.textContent = `ç¬¬${num}å ‚èª²`;
      tabContainer.appendChild(tabBtn);

      const tabContent = document.createElement("div");
      tabContent.id = tabId;
      tabContent.className="tab-content";

      tabContent.innerHTML = `
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
          ${members.map(name => `
            <div class="flex items-center justify-between bg-green-800 p-3 rounded shadow">
              <span class="text-white font-medium">${name}</span>
              <input type="checkbox" class="attendance-${num}" data-name="${name}">
            </div>
          `).join("")}
        </div>
        <div class="text-right text-yellow-300 font-bold">ğŸ‘¥ å‡ºå¸­äººæ•¸ï¼š<span id="count-${num}">0</span> äºº</div>
      `;

      contentContainer.appendChild(tabContent);
      setupAttendance(num);
    }

    function switchTab(tabId, tabBtn){
      document.querySelectorAll(".tab-content").forEach(c=>c.style.display="none");
      document.querySelectorAll(".tab-btn").forEach(t=>t.classList.remove("bg-yellow-500"));
      document.getElementById(tabId).style.display="block";
      tabBtn.classList.add("bg-yellow-500");
    }

    tabContainer.addEventListener("click", e=>{
      if(e.target.classList.contains("tab-btn")) switchTab(e.target.dataset.tab,e.target);
    });

    function setupAttendance(classNum){
      const checkboxes = document.querySelectorAll(`.attendance-${classNum}`);
      const countDisplay = document.getElementById(`count-${classNum}`);
      function updateCount(){ countDisplay.textContent = Array.from(checkboxes).filter(c=>c.checked).length; }
      checkboxes.forEach(cb=>cb.addEventListener("change",updateCount));
      updateCount();
    }

    addClassBtn.addEventListener("click",()=>{
      classCount++;
      createClass(classCount);
      switchTab(`class${classCount}`,document.querySelectorAll(".tab-btn")[classCount-1]);
    });

    saveBtn.addEventListener("click",()=>{
      const payload = [];
      for(let c=1;c<=classCount;c++){
        const checkboxes = document.querySelectorAll(`.attendance-${c}`);
        checkboxes.forEach(cb=>{
          payload.push({
            date: datePicker.value,
            class: c,
            name: cb.dataset.name,
            attendance: cb.checked ? 1 : 0,
            token: "junwu2025" // â† å¹¹éƒ¨å¯†ç¢¼ï¼ˆå¯é¸ï¼‰
          });
        });
      }
      fetch(API_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      }).then(()=>alert("âœ… å·²å„²å­˜ç°½åˆ°è³‡æ–™ï¼"));
        .then(res => res.text())
        .then(msg => alert(msg))
        .catch(err => alert("âŒ ç™¼é€å¤±æ•—ï¼š" + err));
    });

    exportBtn.addEventListener("click",()=>{
      let csv="å ‚æ•¸,å§“å,å‡ºå¸­\n";
      for(let c=1;c<=classCount;c++){
        const checkboxes = document.querySelectorAll(`.attendance-${c}`);
        checkboxes.forEach(cb=>{ csv+=`${c},${cb.dataset.name},${cb.checked?1:0}\n`; });
      }
      const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url; a.download=`${datePicker.value}_attendance.csv`; a.click();
    });

    createClass(1);
    switchTab("class1",document.querySelector(".tab-btn"));
  </script>
</body>
</html>
